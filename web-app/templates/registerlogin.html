<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Gesture Auth System</title>
  <link rel="stylesheet" href="static/style.css">
  <script src="static/script.js" defer></script>
</head>

<body>
  <h1>Hand Angle Authentication</h1>

  <!-- Registration Form -->
  <h2>Register</h2>
  <input type="text" id="reg-username" placeholder="Username" />
  <input type="text" id="reg-gesture" placeholder="Gesture Name" />

  <h4>Hand Angles</h4>
  <table>
    <thead>
      <tr>
        <th>Angle Name</th>
        <th>Value (degrees)</th>
      </tr>
    </thead>
    <tbody id="hand-angles-table-reg">
      <tr>
        <td>Thumb MCP‚ÜíIP</td>
        <td><input data-angle="Thumb MCP‚ÜíIP" type="number" min="0" max="180" placeholder="e.g. 161.44"></td>
      </tr>
      <tr>
        <td>Thumb IP‚ÜíTip</td>
        <td><input data-angle="Thumb IP‚ÜíTip" type="number" min="0" max="180" placeholder="e.g. 133.85"></td>
      </tr>
      <tr>
        <td>Index MCP‚ÜíPIP</td>
        <td><input data-angle="Index MCP‚ÜíPIP" type="number" min="0" max="180" placeholder="e.g. 152.81"></td>
      </tr>
      <tr>
        <td>Index PIP‚ÜíDIP</td>
        <td><input data-angle="Index PIP‚ÜíDIP" type="number" min="0" max="180" placeholder="e.g. 70.18"></td>
      </tr>
      <tr>
        <td>Middle MCP‚ÜíPIP</td>
        <td><input data-angle="Middle MCP‚ÜíPIP" type="number" min="0" max="180" placeholder="e.g. 148.49"></td>
      </tr>
      <tr>
        <td>Middle PIP‚ÜíDIP</td>
        <td><input data-angle="Middle PIP‚ÜíDIP" type="number" min="0" max="180" placeholder="e.g. 69.31"></td>
      </tr>
      <tr>
        <td>Ring MCP‚ÜíPIP</td>
        <td><input data-angle="Ring MCP‚ÜíPIP" type="number" min="0" max="180" placeholder="e.g. 168.76"></td>
      </tr>
      <tr>
        <td>Ring PIP‚ÜíDIP</td>
        <td><input data-angle="Ring PIP‚ÜíDIP" type="number" min="0" max="180" placeholder="e.g. 40.95"></td>
      </tr>
      <tr>
        <td>Pinky MCP‚ÜíPIP</td>
        <td><input data-angle="Pinky MCP‚ÜíPIP" type="number" min="0" max="180" placeholder="e.g. 177.22"></td>
      </tr>
      <tr>
        <td>Pinky PIP‚ÜíDIP</td>
        <td><input data-angle="Pinky PIP‚ÜíDIP" type="number" min="0" max="180" placeholder="e.g. 47.28"></td>
      </tr>
    </tbody>
  </table>

  <button onclick="getLiveAngles('reg')">Get Current Hand Angles</button>
  <button onclick="submitRegister()">Register</button>

  <div id="register-result"></div>

  <!-- Login Form -->
  <h2>Login</h2>
  <input type="text" id="login-username" placeholder="Username" />

  <h4>Hand Angles</h4>
  <table>
    <thead>
      <tr>
        <th>Angle Name</th>
        <th>Value (degrees)</th>
      </tr>
    </thead>
    <tbody id="hand-angles-table-login">
      <tr>
        <td>Thumb MCP‚ÜíIP</td>
        <td><input data-angle="Thumb MCP‚ÜíIP" type="number" min="0" max="180" placeholder="e.g. 161.44"></td>
      </tr>
      <tr>
        <td>Thumb IP‚ÜíTip</td>
        <td><input data-angle="Thumb IP‚ÜíTip" type="number" min="0" max="180" placeholder="e.g. 133.85"></td>
      </tr>
      <tr>
        <td>Index MCP‚ÜíPIP</td>
        <td><input data-angle="Index MCP‚ÜíPIP" type="number" min="0" max="180" placeholder="e.g. 152.81"></td>
      </tr>
      <tr>
        <td>Index PIP‚ÜíDIP</td>
        <td><input data-angle="Index PIP‚ÜíDIP" type="number" min="0" max="180" placeholder="e.g. 70.18"></td>
      </tr>
      <tr>
        <td>Middle MCP‚ÜíPIP</td>
        <td><input data-angle="Middle MCP‚ÜíPIP" type="number" min="0" max="180" placeholder="e.g. 148.49"></td>
      </tr>
      <tr>
        <td>Middle PIP‚ÜíDIP</td>
        <td><input data-angle="Middle PIP‚ÜíDIP" type="number" min="0" max="180" placeholder="e.g. 69.31"></td>
      </tr>
      <tr>
        <td>Ring MCP‚ÜíPIP</td>
        <td><input data-angle="Ring MCP‚ÜíPIP" type="number" min="0" max="180" placeholder="e.g. 168.76"></td>
      </tr>
      <tr>
        <td>Ring PIP‚ÜíDIP</td>
        <td><input data-angle="Ring PIP‚ÜíDIP" type="number" min="0" max="180" placeholder="e.g. 40.95"></td>
      </tr>
      <tr>
        <td>Pinky MCP‚ÜíPIP</td>
        <td><input data-angle="Pinky MCP‚ÜíPIP" type="number" min="0" max="180" placeholder="e.g. 177.22"></td>
      </tr>
      <tr>
        <td>Pinky PIP‚ÜíDIP</td>
        <td><input data-angle="Pinky PIP‚ÜíDIP" type="number" min="0" max="180" placeholder="e.g. 47.28"></td>
      </tr>
    </tbody>
  </table>

  <button onclick="getLiveAngles('login')">Get Current Hand Angles</button>
  <button onclick="submitLogin()">Login</button>

  <div id="login-result"></div>

  <!-- Document List (shows after login) -->
  <div id="document-section" style="display: none;">
    <h2>Your Documents</h2>
    <div id="doc-list" class="doc-list"></div>
    <button id="new-doc-btn" onclick="createNewDocument()">Create New Document</button>
  </div>

  <!-- Document Editor -->
  <div id="editor" class="editor" style="display: none;">
    <h2>Document Editor</h2>
    <input type="text" id="doc-title" placeholder="Document Title" />
    <textarea id="doc-content" placeholder="Document content..."></textarea>
    <button onclick="saveDocument()">Save Document</button>
    <button onclick="closeEditor()">Close</button>
  </div>

  <script>
    function collectAngleData(tableId) {
      const inputs = document.querySelectorAll(`#${tableId} input`);
      const angleData = {};

      inputs.forEach(input => {
        const angleName = input.getAttribute('data-angle');
        const value = input.value.trim();

        if (!value) {
          throw new Error(`Missing value for ${angleName}`);
        }

        const floatVal = parseFloat(value);
        if (isNaN(floatVal)) {
          throw new Error(`Invalid number for ${angleName}`);
        }

        angleData[angleName] = floatVal;
      });

      return angleData;
    }


    async function getLiveAngles(formType) {
      const tableId = formType === 'reg' ? 'hand-angles-table-reg' : 'hand-angles-table-login';
      const resultEl = document.getElementById(formType === 'reg' ? 'register-result' : 'login-result');

      try {
        const response = await fetch("/api/hand-angles");
        const data = await response.json();

        if (!data.hand_present) {
          resultEl.textContent = "üñêÔ∏è Hand is not in view.";
          return;
        }

        const labels = [
          "Thumb MCP‚ÜíIP", "Thumb IP‚ÜíTip",
          "Index MCP‚ÜíPIP", "Index PIP‚ÜíDIP",
          "Middle MCP‚ÜíPIP", "Middle PIP‚ÜíDIP",
          "Ring MCP‚ÜíPIP", "Ring PIP‚ÜíDIP",
          "Pinky MCP‚ÜíPIP", "Pinky PIP‚ÜíDIP"
        ];

        const inputs = document.querySelectorAll(`#${tableId} input`);
        inputs.forEach(input => {
          const label = input.getAttribute('data-angle');
          const index = labels.indexOf(label);
          const angle = data.angles[index];

          if (index !== -1 && angle !== null && angle !== undefined) {
            input.value = angle.toFixed(2);
          } else {
            input.value = ""; // Clear the input if no valid data
          }
        });

        resultEl.textContent = "‚úÖ Hand angles updated!";
      } catch (err) {
        console.error("Error fetching hand angles:", err);
        resultEl.textContent = "‚ùå Could not connect to hand tracking system.";
      }
    }


    async function submitRegister() {
      const username = document.getElementById("reg-username").value.trim();
      const gesture_name = document.getElementById("reg-gesture").value.trim();
      const resultEl = document.getElementById("result");

      if (!username || !gesture_name) {
        resultEl.textContent = "Please fill in all required fields.";
        return;
      }

      let angle_data;
      try {
        angle_data = collectAngleData("hand-angles-table-reg");
      } catch (err) {
        resultEl.textContent = err.message;
        return;
      }

      const res = await fetch("/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          username,
          gesture_name,
          angle_data
        })
      });

      const data = await res.json();
      resultEl.textContent = res.ok
        ? `Registered! Gesture ID: ${data.gesture_password_id}`
        : `Error: ${data.error}`;
    }

    async function submitLogin() {
      const username = document.getElementById("login-username").value.trim();
      const resultEl = document.getElementById("result");

      if (!username) {
        resultEl.textContent = "Username is required.";
        return;
      }

      let angle_data;
      try {
        angle_data = collectAngleData("hand-angles-table-login");
      } catch (err) {
        resultEl.textContent = err.message;
        return;
      }

      const res = await fetch("/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          username,
          angle_data
        })
      });

      const data = await res.json();

      if (res.ok) {
        resultEl.textContent = data.message + (data.confidence ? ` (Confidence: ${data.confidence.toFixed(2)})` : "");

        // Load documents
        loadDocuments(username);
      } else {
        resultEl.textContent = `Error: ${data.error}`;
      }
    }

    async function loadDocuments(username) {
      const res = await fetch(`/documents?username=${username}`);
      if (res.ok) {
        const data = await res.json();
        const docListEl = document.getElementById("doc-list");
        docListEl.innerHTML = "";

        if (data.documents.length === 0) {
          docListEl.innerHTML = "<p>No documents found. Create a new one!</p>";
        } else {
          data.documents.forEach(doc => {
            const docEl = document.createElement("div");
            docEl.className = "document-item";
            docEl.innerHTML = `
              <h3>${doc.title}</h3>
              <p>Last updated: ${new Date(doc.updated_at).toLocaleString()}</p>
              <button onclick="openDocument('${doc.id}', '${username}')">Open</button>
            `;
            docListEl.appendChild(docEl);
          });
        }

        document.getElementById("document-section").style.display = "block";
      }
    }

    let currentDocId = null;
    let currentUsername = null;

    async function openDocument(docId, username) {
      const res = await fetch(`/documents/${docId}?username=${username}`);
      if (res.ok) {
        const doc = await res.json();
        document.getElementById("doc-title").value = doc.title;
        document.getElementById("doc-content").value = doc.content;
        document.getElementById("editor").style.display = "block";

        currentDocId = docId;
        currentUsername = username;
      }
    }

    function closeEditor() {
      document.getElementById("editor").style.display = "none";
      currentDocId = null;
    }

    async function saveDocument() {
      if (!currentDocId || !currentUsername) return;

      const content = document.getElementById("doc-content").value;

      const res = await fetch(`/documents/${currentDocId}?username=${currentUsername}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content })
      });

      if (res.ok) {
        alert("Document saved successfully!");
        loadDocuments(currentUsername);
      } else {
        alert("Error saving document");
      }
    }

    async function createNewDocument() {
      const username = document.getElementById("login-username").value.trim();
      if (!username) return;

      const title = prompt("Enter document title:");
      if (!title) return;

      // You'll need to create a backend endpoint for this
      // For now, we'll just refresh the document list
      alert("New document creation would happen here");
      loadDocuments(username);
    }
  </script>
</body>

</html>