<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gesture Auth System</title>
  <style>
    body { font-family: sans-serif; padding: 2em; max-width: 800px; margin: auto; }
    h2 { margin-top: 2em; }
    input, button, textarea { margin: 0.5em 0; padding: 0.5em; width: 100%; box-sizing: border-box; }
    #result { margin-top: 1em; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: center; }
    th { background: #f5f5f5; }
  </style>
</head>
<body>
  <h1>Gesture Authentication</h1>

  <!-- Registration Form -->
  <h2>Register</h2>
  <input type="text" id="reg-username" placeholder="Username" />
  <input type="text" id="reg-gesture" placeholder="Gesture Name" />

  <h4>Hand Positions</h4>
  <table>
    <thead>
      <tr><th>Joint ID</th><th>X</th><th>Y</th><th>Z</th></tr>
    </thead>
    <tbody id="hand-positions-table-reg">
      <tr><td>wrist</td><td><input data-joint="wrist" data-axis="x"></td><td><input data-joint="wrist" data-axis="y"></td><td><input data-joint="wrist" data-axis="z"></td></tr>
      <tr><td>thumb_tip</td><td><input data-joint="thumb_tip" data-axis="x"></td><td><input data-joint="thumb_tip" data-axis="y"></td><td><input data-joint="thumb_tip" data-axis="z"></td></tr>
      <tr><td>index_tip</td><td><input data-joint="index_tip" data-axis="x"></td><td><input data-joint="index_tip" data-axis="y"></td><td><input data-joint="index_tip" data-axis="z"></td></tr>
      <tr><td>middle_tip</td><td><input data-joint="middle_tip" data-axis="x"></td><td><input data-joint="middle_tip" data-axis="y"></td><td><input data-joint="middle_tip" data-axis="z"></td></tr>
      <tr><td>ring_tip</td><td><input data-joint="ring_tip" data-axis="x"></td><td><input data-joint="ring_tip" data-axis="y"></td><td><input data-joint="ring_tip" data-axis="z"></td></tr>
      <tr><td>pinky_tip</td><td><input data-joint="pinky_tip" data-axis="x"></td><td><input data-joint="pinky_tip" data-axis="y"></td><td><input data-joint="pinky_tip" data-axis="z"></td></tr>
    </tbody>
  </table>

  <button onclick="submitRegister()">Register</button>

  <!-- Login Form -->
  <h2>Login</h2>
  <input type="text" id="login-username" placeholder="Username" />

  <h4>Hand Positions</h4>
  <table>
    <thead>
      <tr><th>Joint ID</th><th>X</th><th>Y</th><th>Z</th></tr>
    </thead>
    <tbody id="hand-positions-table-login">
      <tr><td>wrist</td><td><input data-joint="wrist" data-axis="x"></td><td><input data-joint="wrist" data-axis="y"></td><td><input data-joint="wrist" data-axis="z"></td></tr>
      <tr><td>thumb_tip</td><td><input data-joint="thumb_tip" data-axis="x"></td><td><input data-joint="thumb_tip" data-axis="y"></td><td><input data-joint="thumb_tip" data-axis="z"></td></tr>
      <tr><td>index_tip</td><td><input data-joint="index_tip" data-axis="x"></td><td><input data-joint="index_tip" data-axis="y"></td><td><input data-joint="index_tip" data-axis="z"></td></tr>
      <tr><td>middle_tip</td><td><input data-joint="middle_tip" data-axis="x"></td><td><input data-joint="middle_tip" data-axis="y"></td><td><input data-joint="middle_tip" data-axis="z"></td></tr>
      <tr><td>ring_tip</td><td><input data-joint="ring_tip" data-axis="x"></td><td><input data-joint="ring_tip" data-axis="y"></td><td><input data-joint="ring_tip" data-axis="z"></td></tr>
      <tr><td>pinky_tip</td><td><input data-joint="pinky_tip" data-axis="x"></td><td><input data-joint="pinky_tip" data-axis="y"></td><td><input data-joint="pinky_tip" data-axis="z"></td></tr>
    </tbody>
  </table>

  <button onclick="submitLogin()">Login</button>

  <div id="result"></div>
  
  <!-- Document List (shows after login) -->
  <div id="document-section" style="display: none;">
    <h2>Your Documents</h2>
    <div id="doc-list" class="doc-list"></div>
    <button id="new-doc-btn" onclick="createNewDocument()">Create New Document</button>
  </div>
  
  <!-- Document Editor -->
  <div id="editor" class="editor">
    <h2>Document Editor</h2>
    <input type="text" id="doc-title" placeholder="Document Title" />
    <textarea id="doc-content" placeholder="Document content..."></textarea>
    <button onclick="saveDocument()">Save Document</button>
    <button onclick="closeEditor()">Close</button>
  </div>
  
  <script>
    function collectHandPositions(tableId) {
      const inputs = document.querySelectorAll(`#${tableId} input`);
      const joints = {};

      inputs.forEach(input => {
        const joint = input.getAttribute('data-joint');
        const axis = input.getAttribute('data-axis');
        const value = input.value.trim();

        if (!value) {
          throw new Error(`Missing ${axis.toUpperCase()} value for ${joint}`);
        }

        const floatVal = parseFloat(value);
        if (isNaN(floatVal)) {
          throw new Error(`Invalid number for ${joint} ${axis}`);
        }

        joints[joint] = joints[joint] || { joint_id: joint };
        joints[joint][axis] = floatVal;
      });

      return Object.values(joints);
    }


    async function submitRegister() {
      const username = document.getElementById("reg-username").value.trim();
      const gesture_name = document.getElementById("reg-gesture").value.trim();
      const resultEl = document.getElementById("result");

      if (!username || !gesture_name) {
        resultEl.textContent = "Please fill in all required fields.";
        return;
      }

      let hand_positions;
      try {
        hand_positions = collectHandPositions("hand-positions-table-reg");
      } catch (err) {
        resultEl.textContent = err.message;
        return;
      }

      const res = await fetch("/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          username,
          gesture_name,
          hand_positions
        })
      });


      const data = await res.json();
      resultEl.textContent = res.ok
        ? `Registered! Gesture ID: ${data.gesture_password_id}`
        : `Error: ${data.error}`;
    }


    async function submitLogin() {
      const username = document.getElementById("login-username").value.trim();
      const resultEl = document.getElementById("result");

      if (!username) {
        resultEl.textContent = "Username is required.";
        return;
      }

      let hand_positions;
      try {
        hand_positions = collectHandPositions("hand-positions-table-login");
      } catch (err) {
        resultEl.textContent = err.message;
        return;
      }

      const res = await fetch("/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          username,
          gesture_data: hand_positions
        })
      });

      const data = await res.json();
      resultEl.textContent = res.ok
        ? data.message + (data.confidence ? ` (Confidence: ${data.confidence.toFixed(2)})` : "")
        : `Error: ${data.error}`;
    }

  </script>
</body>
</html>